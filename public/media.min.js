/*
* autther : Mohammad Ammar Alrez
* url :https://github.com/ammaralrez97/media-component
* */

$.ajaxSetup({headers:{"X-CSRF-TOKEN":$("meta[name='csrf']").attr("content")}});let media={items:{img:"./default.jpg",path:"/storage",csrf:$("meta[name='csrf']").attr("content"),routes:JSON.parse($("meta[name='mediaRoute']").attr("content")),ajaxLoad:null,mediaDropzone:null,id:null,multi:!1,value:null,files:[],old_files:[]},get:{files(e=null){e=null==e?1:e,null!=media.items.ajaxLoad&&media.items.ajaxLoad.abort(),media.items.ajaxLoad=$.ajax({url:media.items.routes.get,method:"post",data:{page:e},success(e){media.items.ajaxLoad=null,$("#media-content").html(""),e.files.forEach(e=>{$("#media-content").append(media.cards.model(e.path+e.name,e.id)),media.items.files[e.id]=e.path+e.name}),$("#media-content").append(media.pagination(e))}})},array(e){$.ajax({url:media.items.routes.files,method:"post",async:!1,data:{items:e},success(e){e.files.forEach(e=>{media.items.files[e.id]=e.path+e.name})}})}},cards:{model(e,a){e=media.items.path+e;let i=media.items.multi?"checkbox":"radio",t="";try{media.items.multi?-1!=media.items.value.indexOf(a)&&(t="checked"):media.items.value==a&&(t="checked")}catch(l){}return` <div class="col-md-2 col-3 mt-1">
                         <div class="custom-control custom-${i} image-checkbox">
                             <input type="${i}"  value="${a}" name="media[]" class="custom-control-input mediaInput" ${t} id="${a}">
                             <label class="custom-control-label" for="${a}">
                                 <img onerror="this.src='${media.items.img}'" src="${e}" alt="#" class="img-fluid">
                             </label>
                         </div>
                     </div>`},input(e){let a=media.items.files[e];a=media.items.path+a;let i="s"+parseInt(1e7*Math.random());return` <div  id="dev-${i}" class="col-md-2 col-3 mt-1 media-cards"><div class="custom-control   image-checkbox"><button data-id="${e}" id="${i}" type="button" class="btn btn-sm  remove-media-btn" style=""> X</button><label class="custom-control-label" for="xxx"><img onerror="this.src='${media.items.img}'" src="${a}" alt="#" class="img-fluid"></label></div></div>`}},pagination(e){let a=`  <li onclick="media.get.files(1)" data-page="0" class="page-item media-page">
      <a class="page-link" href="#" aria-label="Previous">
        <span aria-hidden="true">&laquo;</span>
        <span class="sr-only">Previous</span>
      </a>
    </li>`,i=`<li  onclick="media.get.files(${e.pages})" data-page="${e.pages}" class="page-item media-page">
      <a class="page-link" href="#" aria-label="Next">
        <span aria-hidden="true">&raquo;</span>
        <span class="sr-only">Next</span>
      </a>
    </li>`,t="";return e.pages<3&&(a="",i=""),1!=parseInt(e.current)?t+=`<li onclick="media.get.files(${e.current-1})" class="page-item media-page"><a class="page-link" href="#">${e.current-1}</a></li>`:a="",t+=`<li onclick="media.get.files(${e.current})" data-page="${e.current}" class="page-item active media-page"><a class="page-link" href="#">${e.current}</a></li>`,parseInt(e.pages)>=parseInt(e.current)+1?t+=`<li onclick="media.get.files(${parseInt(e.current)+1})" data-page="${parseInt(e.current)+1}" class="page-item media-page"><a class="page-link" href="#">${parseInt(e.current)+1}</a></li>`:i="",`<div class="col-12 mt-2 text-center"><nav class="text-center" aria-label="Page navigation example">
  <ul class="pagination">
    ${a}
    ${t}
 
     ${i}
  </ul>
</nav></div>`},dz(){Dropzone.autoDiscover=!1,null!=media.items.mediaDropzone&&mediaDropzone.destroy(),media.items.mediaDropzone=new Dropzone("div#media-dropzone",{url:media.items.routes.upload,headers:{"x-csrf-token":media.items.csrf},maxFilesize:2,init:function(){this.on("complete",function(e){media.get.files(),setTimeout(()=>{mediaDropzone.removeFile(e)},3e3)})}})},init(){$("body").append(media.model()),media.dz(),$(".media-value").each(function(){if($(this).data("multi")){let e=JSON.parse($(this).val());e!=[]&&null!=e&&e.forEach(e=>{-1==media.items.old_files.indexOf(parseInt(e))&&media.items.old_files.push(parseInt(e))})}else{let a=$(this).val();""!=a&&-1==media.items.old_files.indexOf(parseInt(a))&&media.items.old_files.push(parseInt(a))}}),media.items.old_files!=[]&&0!=media.items.old_files.length&&null!=media.items.old_files&&(media.get.array(media.items.old_files),$(".media-value").each(function(){$("#content-media-"+this.id).html("");let e="";if($(this).data("multi")){let a=JSON.parse($(this).val());null!=a&&a!=[]&&a.forEach(a=>{e+=media.cards.input(a)})}else""!=$(this).val()&&(e=media.cards.input($(this).val()));$("#content-media-"+this.id).html(e)}))},event:{media:{click(e){media.items.id=$(e).data("id"),media.items.multi=!!$(e).data("multi"),media.items.value=media.items.multi?[]:null,media.items.multi?""==$("#"+media.items.id).val()?media.items.value=[]:media.items.value=JSON.parse($("#"+media.items.id).val()):media.items.value=$("#"+media.items.id).val(),$("#exampleModal").modal("show")},change(e){let a=$(e).val();if(a=parseInt(a),$(e).is(":checked")){if(media.items.multi){let i=media.items.value.indexOf(a);-1==i&&media.items.value.push(a)}else media.items.value=a}else if(media.items.multi){let t=media.items.value.indexOf(a);t>-1&&media.items.value.splice(t,1)}else media.items.value=null}},save(){$("#"+media.items.id).val(media.items.value),$("#exampleModal").modal("hide"),$("#content-media-"+media.items.id).html("");let e="";media.items.multi?($("#"+media.items.id).val(JSON.stringify(media.items.value)),media.items.value.forEach(a=>{e+=media.cards.input(a)})):($("#"+media.items.id).val(media.items.value),e=media.cards.input(media.items.value)),$("#content-media-"+media.items.id).html(e)}},model:()=>'<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg"><div class="modal-content "><div class="modal-header"><h5 class="modal-title" id="exampleModalLabel">Modal title</h5><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body"><nav><div class="nav nav-tabs" id="nav-tab" role="tablist"><button class="nav-link active" id="nav-content-tab" data-toggle="tab"data-target="#nav-content" type="button" role="tab" aria-controls="nav-content"aria-selected="true">content</button><button class="nav-link" id="nav-upload-tab" data-toggle="tab" data-target="#nav-upload"type="button" role="tab" aria-controls="nav-upload" aria-selected="false">upload</button></div></nav><div class="tab-content" id="nav-tabContent"><div class="tab-pane fade show active" id="nav-content" role="tabpanel"aria-labelledby="nav-content-tab"><div class="row mt-3" id="media-content"></div></div><div class="tab-pane fade" id="nav-upload" role="tabpanel" aria-labelledby="nav-upload-tab"><div class="dropzone" id="media-dropzone"></div></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button><button type="button" id="save" class="btn btn-primary">Save changes</button></div></div></div></div>'};media.init(),$(document).on("click",".media",function(){media.event.media.click(this),media.get.files()}),$(document).on("change",".mediaInput",function(){media.event.media.change(this)}),$(document).on("click","#save",function(){media.event.save()}),$(document).on("click",".remove-media-btn",function(){let e=$(this).data("id"),a=$(this).parents(".media-component").find("input"),i=a.val();if(a.data("multi"))try{(i=JSON.parse(i)).splice(i.indexOf(e),1),$(this).parent().parent().remove(),a.val(JSON.stringify(i))}catch(t){}else $(this).parent().parent().remove(),a.val("")});